name: Sui portfolio daily snapshot (wallet + DeFi via BlockVision + USD)

on:
  # schedule:
  #   - cron: '5 17 * * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 0) Sanity: secret exists & endpoint reachable (status only, no leak)
      - name: Check BLOCKVISION_API_KEY presence
        run: |
          if [ -z "${{ secrets.BLOCKVISION_API_KEY }}" ]; then
            echo "BLOCKVISION_API_KEY is MISSING"; exit 1; fi
          echo "BLOCKVISION_API_KEY is set âœ…"
      - name: Sanity ping BlockVision
        env:
          SUI_ADDRESS: '0xa63ef51b8abf601fb40d8514050a8d5613c0509d4b36323dc4439ee6c69d704e'
        run: |
          set -eux
          CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "X-API-Key: ${{ secrets.BLOCKVISION_API_KEY }}" \
            -H "User-Agent: sui-portfolio-bot/1.0 (+github-actions)" \
            "https://api.blockvision.org/v2/sui/account/defiPortfolio?address=$SUI_ADDRESS")
          echo "BlockVision status for $SUI_ADDRESS: $CODE"
          if [ "$CODE" != "200" ]; then
            echo "Warning: BlockVision returned $CODE for $SUI_ADDRESS"
          fi

      # 1) Pull DeFi portfolio (SuiVision backend via BlockVision API)
      - name: Fetch DeFi portfolio (BlockVision)
        env:
          SUI_ADDRESSES: '0xa63ef51b8abf601fb40d8514050a8d5613c0509d4b36323dc4439ee6c69d704e'
          BLOCKVISION_API_KEY: ${{ secrets.BLOCKVISION_API_KEY }}
          OUT_DIR: data
        run: |
          python scripts/fetch_defi_blockvision.py

      # 2) Wallet balances + merge + USD totals
      - name: Build wallet snapshot & merge
        env:
          SUI_ADDRESSES: '0xa63ef51b8abf601fb40d8514050a8d5613c0509d4b36323dc4439ee6c69d704e'
          SUI_RPC_URL: https://fullnode.mainnet.sui.io:443
          OUT_DIR: data
          BLOCKVISION_API_KEY: ${{ secrets.BLOCKVISION_API_KEY }}
        run: |
          python scripts/sui_daily_portfolio.py

      # 3) Human-readable report
      - name: Build Markdown report
        run: |
          python scripts/summarize_latest.py > data/defi_summary.md
          ls -lah data

      - name: Commit snapshot
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add -A data
          git commit -m "chore: daily snapshot" || echo "no changes"
          git push
